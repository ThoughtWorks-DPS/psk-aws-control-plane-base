# yamllint disable rule:line-length
---
name: setup environment

description: load values from 1password vault

inputs:

  instance:
    description: input value that can be used to control which actions are run
    required: false
    default: ""

runs:
  using: "composite"

  steps:

    - name: run step if instance matches
      if: ${{ inputs.instance != 'prod-i01-aws-us-east-2' }}
      uses: 1password/load-secrets-action@581a835fb51b8e7ec56b71cf2ffddd7e68bb25e0    # v2.0.0
      with:
        export-env: true
      env:
        TFE_TOKEN: op://empc-lab/svc-terraform-cloud/team-api-token
        GREN_GITHUB_TOKEN: op://empc-lab/svc-github/access-token
        SLACK_BOT_TOKEN: op://empc-lab/svc-slack/post-bot-token
        AWS_ACCESS_KEY_ID: op://empc-lab/aws-dps-2/PSKProdServiceAccount-aws-access-key-id
        AWS_SECRET_ACCESS_KEY: op://empc-lab/aws-dps-2/PSKProdServiceAccount-aws-secret-access-key

    - name: set ./.terraformrc
      uses: ThoughtWorks-DPS/terraform-action/terraformrc@main

    - name: populate ${{ inputs.instance }} tfvar template
      uses: ThoughtWorks-DPS/1password-action/tpl@2f0a75fadf187f444c855270f8ae09a5c95747d0     # v0.2.3
      with:
        tpl-path: environments
        tpl-file: sbx-i01-aws-us-east-1.auto.tfvars.json
